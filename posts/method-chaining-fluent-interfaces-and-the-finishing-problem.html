


<!DOCTYPE html>
<html lang="en">
	<head>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=Edge"/>

	<title>Dave Glick - Method Chaining, Fluent Interfaces, and the Finishing Problem</title>
        <meta name="description" content="The personal blog of Dave Glick" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0">        

        <link type="application/rss+xml" rel="alternate" title="Dave Glick" href="/feed.rss" />
        <link type="application/atom+xml" rel="alternate" title="Dave Glick" href="/feed.atom" />
        <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
        <link rel="icon" href="/favicon.ico" type="image/x-icon">
        <link rel="icon" type="image/png" href="/favicon-32x32.png" sizes="32x32" />
        <link rel="icon" type="image/png" href="/favicon-16x16.png" sizes="16x16" />

        <link href="/Content/bootstrap/bootstrap.css" rel="stylesheet" />
        <link href="/Content/prettify.css" rel="stylesheet">
        <link href="/Content/github.css" rel="stylesheet">
        <link href="/Content/master.css" rel="stylesheet" />

        <meta name="application-name" content="Dave Glick" />
        <meta name="msapplication-tooltip" content="Dave Glick" />
        <meta name="msapplication-starturl" content="/" />

        <meta property="og:title" content="Dave Glick - Method Chaining, Fluent Interfaces, and the Finishing Problem" />
        
        <meta property="og:type" content="website" />
        <meta property="og:url" content="http://daveaglick.com/posts\method-chaining-fluent-interfaces-and-the-finishing-problem.cshtml" />
        <!-- TODO: More social graph meta tags -->

        <script src="/Scripts/jquery-2.1.1.min.js"></script>
        <script src="/Scripts/bootstrap.min.js"></script>     
        <script src="/Scripts/prettify.js"></script>
        <script src="http://d3js.org/d3.v3.min.js"></script>
        <script src="/Scripts/trianglify.min.js"></script>
        <script src="/Scripts/Please-compressed.js"></script>
        <script src="//ajax.googleapis.com/ajax/libs/webfont/1.4.7/webfont.js"></script>
        <script>
            WebFont.load({
                google: {
                    families: ['Lato:400,900:latin', 'Droid+Serif::latin']
                },
                custom: {
                    families: ['daveaglick'],
                    urls: ['https://fontastic.s3.amazonaws.com/gfxCC547kHqmQZtxrW5KFY/icons.css']
                }
            });
        </script>
	</head>
	<body onload="prettyPrint()">

<div id="page-wrapper">
 <div class="container topnav container-sm-height">
  <div class="row nav-row row-sm-height">
   <div class="col-xs-3 col-sm-6 logo-col col-sm-height col-bottom">                        <a href="/">Dave Glick</a>
</div>
   <div class="col-xs-9 visible-xs-block">
    <div class="visible-xs-block">                            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".collapse">
                                <span class="icon-bar"></span>
                                <span class="icon-bar"></span>
                                <span class="icon-bar"></span>
                            </button>
</div>
   </div>
   <div class="clearfix visible-xs-block"></div>
   <div class="col-xs-12 col-sm-2 nav-col collapse col-sm-height" style="visibility: visible;">
    <ul class="list-unstyled">
     <li>/ <a href="/about"> About</a></li>
     <li>/ <a href="/posts"> Archive</a></li>
     <li>/ <a href="/tags"> Tags</a></li>
     <li>/ <a href="/likes"> Likes</a></li>
    </ul>                        <a class="twitter-follow-button" href="https://twitter.com/daveaglick" data-show-count="false" data-lang="en">Follow @daveaglick</a>

   </div>
   <div class="clearfix visible-xs-block"></div>
   <div class="col-xs-12 col-sm-4 proj-col collapse col-sm-height" style="visibility: visible;">
    <div>Projects</div>
    <ul class="list-unstyled">
     <li>/ <a href="http://wyam.io">Wyam</a></li>
     <li>/ <a href="http://fluentbootstrap.com">FluentBootstrap</a></li>
     <li>/ <a href="https://github.com/daveaglick/LINQPad.CodeAnalysis">LINQPad.CodeAnalysis</a></li>
     <li>/ <a href="/razordatabase">RazorDatabase</a></li>
    </ul>
   </div>
  </div>
 </div>
 <div id="body-content" class="container">
  <div class="row">
   <div class="col-md-12">



<div class="banner container-sm-height">
 <div class="row row-sm-height">
  <div class="col-sm-8 col-sm-height col-bottom">            <div class="title">Method Chaining, Fluent Interfaces, and the Finishing Problem</div>
                <div class="lead">Or Why You Can&#39;t Have Your Cake And Eat It Too</div>
</div>
  <div class="col-sm-4 col-sm-height col-bottom stats">
   <div class="row">
    <div class="col-sm-12">                    <hr class="visible-xs-block" />
                        <div><strong>Tags</strong></div>
                        <div>

     <a role="button" href="/tags/fluent-interfaces" class="btn btn-default btn-sm tag-button icon-tag-2"> fluent interfaces</a>
     <a role="button" href="/tags/method-chaining" class="btn btn-default btn-sm tag-button icon-tag-2"> method chaining</a>                        </div>     
                        <div><strong>Published</strong></div>
                        <div class="icon-calendar"> &nbsp;Friday, May 30, 2014</div>
                    <div><strong>Comments</strong></div>
                    <div class="icon-talk-chat-2"> &nbsp;<a href="#disqus_thread" data-disqus-identifier="method-chaining-fluent-interfaces-and-the-finishing-problem"></a></div>               
                    <div><a class="twitter-share-button" href="https://twitter.com/share" data-url="http://www.daveaglick.com/posts/method-chaining-fluent-interfaces-and-the-finishing-problem" data-via="daveaglick" data-text="Method Chaining, Fluent Interfaces, and the Finishing Problem" data-count="none">Tweet</a></div>

    </div>
   </div>
  </div>
 </div>
</div>
<hr />

<div class="row">
 <div id="post-content" class="col-sm-12">
<p><a href="http://martinfowler.com/bliki/FluentInterface.html">Fluent interfaces</a> have become very popular in C# APIs recently. <a href="http://martinfowler.com/bliki/FluentInterface.html">Martin Fowler presumably coined the term in 2005</a> and at the time he wrote, “It's not a common style, but one we think should be better known”. Fluent interfaces are based on the older concepts of <a href="http://en.wikipedia.org/wiki/Method_chaining">method chaining</a> and <a href="http://en.wikipedia.org/wiki/Method_cascading">method cascading</a> (and the term has actually been misused quite a bit to refer to any type of method chaining), whereby the context of a call is passed through via method return values to the next method in the chain. This can result in a much more readable and concise API, particularly when many or a complex series of options or operations are available.</p>

<p>The focus of this blog post is on a particular challenge of fluent interfaces and method chaining known as the “finishing problem.” To illustrate it, consider a logging framework. It might allow some number of chained methods such as <code>Severity()</code>, <code>Source()</code>, <code>User()</code>, <code>CallSite()</code>, etc.:</p>

<pre class="prettyprint">Log.Message("Oh, noes!").Severity(Severity.Bad).User("jsmith");</pre>

<p>Looks nice, right? The problem here is that the logging framework doesn’t know when to write the log message to the log file. Do I do it in the <code>User()</code> method? What if I don’t use the <code>User()</code> method or I put it before the <code>Severity()</code> method, then when do I write to the file? This problem occurs any time you want the entire result of a method chain to take some external action other than manipulating the context of the chain.</p>

<p>There are a number of patterns for mitigating the finishing problem. Notice that I didn’t say <em>solving the finishing problem</em> – it turns out this can’t really be completely resolved, at least not generally.</p>

<h1>Terminating Method</h1>

<p>This first technique is probably one of the easier, but it’s also a bad <a href="http://en.wikipedia.org/wiki/Code_smell">code smell</a>. It requires the introduction of a method that serves to complete the chain and act on it’s final context. For example:</p>

<pre class="prettyprint">Log.Message("Oh, noes!").Severity(Severity.Bad).User("jsmith").Write();</pre>

<p>See how we added the <code>Write()</code> method there at the end? That <code>Write()</code> method takes the chain context, writes it to disk, and doesn’t return anything (effectively stopping the chain). So why is this so bad? For one, it would be very easy to forget the <code>Write()</code> method at the end of the chain. This technique requires the programmer to remember something that the compiler can’t check and that wouldn’t be picked up at runtime if they forgot. That’s a recipe for misery. It’s also superfluous. Why the heck do I need a <code>Write()</code> method if that’s the whole point of using the log in the first place?</p>

<h1>Method Argument</h1>

<p>This technique encloses the method chain inside a containing method that will be responsible for acting on the result of the chain. For example:</p>

<pre class="prettyprint">Log.Write(new Message("Oh, noes!").Severity(Severity.Bad).User("jsmith"));</pre>

<p>In this case, the <code>Log.Write()</code> method accepts an argument of the type that the chain passes along. Because the whole chain is an input to the <code>Write()</code> method, it can act on the result and write to the file. The downside to this technique is that you have to instantiate an object to pass to the <code>Write()</code> method. It’s also not particularly elegant.</p>

<h1>Delegate Argument</h1>

<p>This technique is very similar to the last one except that instead of passing in a newly instantiated object, one is instantiated by the <code>Write()</code> method and passed to a delegate that manipulates it before being acted on by <code>Write()</code>. The use of lambdas makes this look fairly tidy:</p>

<pre class="prettyprint">Log.Write(x => x.Message("Oh, noes!").Severity(Severity.Bad).User("jsmith"));</pre>

<p>This has an advantage over the previous technique in that the argument to the delegate is already typed and so Intellisense can be used to provide a slightly better experience (instead of having to known what types of objects should be instantiated and passed to the method). Of course, the downside is that the syntax is getting even further afield of the nice concise ideal.</p>

<h1>Casting</h1>

<p>I have not seen mention of this technique anywhere else, probably because it only works well in specific scenarios. The idea is that the external action is taken upon casting the chain context object to some other type via a casting operator. For example:</p>

<pre class="prettyprint">LogWriter writer = (LogWriter)Log.Message("Oh, noes!").Severity(Severity.Bad).User("jsmith");</code>></pre>

<p>Inside the chain context class (let’s call it LogOptions) you might have something like:</p>

<pre class="prettyprint">public class LogOptions
{
  public static string LogPath { get; set; }

  public static implicit operator LogWriter(LogOptions ops)
  {
    File.AppendAllText(LogPath, ops.ToString());
    return new LogWriter(ops);
  }
}</pre>

<p>This technique really only makes sense if you’re actually going to do something with that <code>LogWriter</code> instance. If not, it’s going to create a bunch of squiggles in Visual Studio telling you it’s an unused variable and drive you nuts. However, this can be valuable if you’re working with another API that you know expects certain types of objects.</p>

<h1>Rewinding</h1>

<p>In very specific situations you may be able to essentially “undo” the result of the previous method in the chain on each subsequent one. This lets you keep the original ideal syntax:</p>

<pre class="prettyprint">Log.Message("Oh, noes!").Severity(Severity.Bad).User("jsmith");</pre>

<p>Then, inside each method <code>Message()</code>, <code>Severity()</code>, and <code>User()</code>, check to see if it’s the first call in the chain (this can be determined by setting a flag in the chain context object on each chained method – if the flag isn’t set, this is the first method in the chain). If it’s not the first method in the chain, undo whatever the previous method did before doing it again with the new context state. For example, in the log scenario remove the last line in the file before appending a new replacement one (obviously you wouldn’t actually want to do this for a log file).</p>

<h1>Buffering</h1>

<p>You may be able to buffer the result of the chained methods until some other action that you know is going to happen takes place. For example, in the log example, the methods <code>Message()</code>, <code>Severity()</code>, and <code>User()</code> could add their respective state information to the <code>Log</code> instance and then output the log message <em>on the next</em> call to <code>Log.Message()</code>. You obviously wouldn't want to do that for this specific example because your log messages would get delayed and possibly never sent, but hopefully you get the idea. As it turns out, I actually used a form of this approach to handle the fluent interfaces in <a href="http://fluentbootstrap.com">FluentBootstrap</a>.</p>

<h1>Don’t Use a Fluent Interface</h1>

<p>It seems like everyone is trying to introduce method chains and fluent interfaces into their APIs recently. In my opinion, this often just causes more trouble than it solves. Maintaining the context objects for a complex fluent interface can be challenging and with the availability of named and optional arguments in C# methods now, I rarely see much syntactic benefit. To me, the following syntax with named arguments is just as terse and understandable as the fluent interface version (if not more so):</p>

<pre class="prettyprint">Log.Message("Oh, noes!", severity: Severty.Bad, user: "jsmith");</pre>

<p>In general, I’ve found fluent interfaces work very well for populating or initializing some set of options within a settings object that you’re going to pass around. As soon as you start trying to introduce external logic into the picture they become much more difficult to get right. Sometimes the best solution is to rethink the problem.</p></div>
</div>
<hr />

<div class="row">
 <div class="col-sm-12">        <div id="disqus_thread"></div>
        <script type="text/javascript">
            /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
            var disqus_shortname = 'somedave'; // required: replace example with your forum shortname
            var disqus_identifier = 'method-chaining-fluent-interfaces-and-the-finishing-problem';
            var disqus_title = 'Method Chaining, Fluent Interfaces, and the Finishing Problem';
            var disqus_url = 'http://www.daveaglick.com/posts/method-chaining-fluent-interfaces-and-the-finishing-problem';

            /* * * DON'T EDIT BELOW THIS LINE * * */
            (function() {
                var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
                dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
                (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
            })();
        </script>
        <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
        <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>    
</div>
</div></div>
  </div>
 </div>
</div>        
<div id="sticky-footer-wrapper">
 <div id="sticky-footer">
  <div class="container">
   <small>                        
                            Copyright © 2015 by Dave Glick. All jams and jellies preserved. The opinions expressed herein are my own and do not represent those of my employer or any other third-party views in any way. This work is licensed under a
                            <a href="http://creativecommons.org/licenses/by/4.0/" rel="license">
    <span class="icon-creative-commons"></span> Creative Commons Attribution 4.0 International License</a>.
                            <br />
                            <a href="/feed.rss">
    <span class="icon-rss"></span> RSS Feed</a> | <a href="/feed.atom">
    <span class="icon-rss"></span> Atom Feed</a>
                            <br />
                            <a href="https://github.com/daveaglick/daveaglick">
    <span class="icon-github-square"></span> This Site on GitHub</a> | <strong><a href="http://wyam.io">Generated by Wyam</a></strong>
                        

   </small>
  </div>
 </div>
</div>
        <script type="text/javascript">
            /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
            var disqus_shortname = 'somedave'; // required: replace example with your forum shortname

            /* * * DON'T EDIT BELOW THIS LINE * * */
            (function () {
                var s = document.createElement('script'); s.async = true;
                s.type = 'text/javascript';
                s.src = '//' + disqus_shortname + '.disqus.com/count.js';
                (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
            }());

            // Google Analytics
            (function (i, s, o, g, r, a, m) {
                i['GoogleAnalyticsObject'] = r; i[r] = i[r] || function () {
                    (i[r].q = i[r].q || []).push(arguments)
                }, i[r].l = 1 * new Date(); a = s.createElement(o),
                m = s.getElementsByTagName(o)[0]; a.async = 1; a.src = g; m.parentNode.insertBefore(a, m)
            })(window, document, 'script', '//www.google-analytics.com/analytics.js', 'ga');

            ga('create', 'UA-54470483-1', 'auto');
            ga('send', 'pageview');

            // Twitter
            window.twttr = (function (d, s, id) {
                var t, js, fjs = d.getElementsByTagName(s)[0];
                if (d.getElementById(id)) return;
                js = d.createElement(s); js.id = id;
                js.src = "https://platform.twitter.com/widgets.js";
                fjs.parentNode.insertBefore(js, fjs);
                return window.twttr || (t = { _e: [], ready: function (f) { t._e.push(f) } });
            }(document, "script", "twitter-wjs"));

            // Background
            var colors = Please.make_color({
                golden: false,
                colors_returned: 3,
                saturation: .4
            });
            var t = new Trianglify({
                x_gradient: colors,
                y_gradient: ["#FFFFFF"]
            });
            var pattern = t.generate(document.body.clientWidth, document.body.clientHeight);
            document.body.setAttribute('style', 'background-image: ' + pattern.dataUrl);
        </script>
	</bodyonload="prettyPrint()">
</html>

