


<!DOCTYPE html>
<html lang="en">
	<head>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=Edge"/>

	<title>Dave Glick - Debugging Stack Overflows on IIS</title>
        <meta name="description" content="The personal blog of Dave Glick" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0">        

        <link type="application/rss+xml" rel="alternate" title="Dave Glick" href="/feed.rss" />
        <link type="application/atom+xml" rel="alternate" title="Dave Glick" href="/feed.atom" />
        <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
        <link rel="icon" href="/favicon.ico" type="image/x-icon">
        <link rel="icon" type="image/png" href="/favicon-32x32.png" sizes="32x32" />
        <link rel="icon" type="image/png" href="/favicon-16x16.png" sizes="16x16" />

        <link href="/Content/bootstrap/bootstrap.css" rel="stylesheet" />
        <link href="/Content/prettify.css" rel="stylesheet">
        <link href="/Content/github.css" rel="stylesheet">
        <link href="/Content/clean-blog.css" rel="stylesheet" />
        <link href="/Content/master.css" rel="stylesheet" />
        <link href="http://maxcdn.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.min.css" rel="stylesheet" type="text/css">
        <link href='http://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
        <link href='http://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/css'>


        <meta name="application-name" content="Dave Glick" />
        <meta name="msapplication-tooltip" content="Dave Glick" />
        <meta name="msapplication-starturl" content="/" />

        <meta property="og:title" content="Dave Glick - Debugging Stack Overflows on IIS" />
        
        <meta property="og:type" content="website" />
        <meta property="og:url" content="http://daveaglick.com/posts/debugging-stack-overflows-on-iis" />
        <!-- TODO: More social graph meta tags -->

        <script src="/Scripts/jquery-2.1.1.min.js"></script>
        <script src="/Scripts/bootstrap.min.js"></script>     
        <script src="/Scripts/prettify.js"></script>
        <script src="/Scripts/clean-blog.js"></script>
        <script src="http://d3js.org/d3.v3.min.js"></script>
        <script src="/Scripts/trianglify.min.js"></script>
        <script src="/Scripts/Please-compressed.js"></script>
        </script>
            
        <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
        <!--[if lt IE 9]>
                <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
                <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
        <![endif]-->
    
	</head>
	<body onload="prettyPrint()">
                
                <!-- Navigation -->
                <nav class="navbar navbar-default navbar-custom navbar-fixed-top">
                        <div class="container-fluid">
                                <!-- Brand and toggle get grouped for better mobile display -->
                                <div class="navbar-header page-scroll">
                                        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#navbar-collapse">
                                        <span class="sr-only">Toggle navigation</span>
                                        <span class="icon-bar"></span>
                                        <span class="icon-bar"></span>
                                        <span class="icon-bar"></span>
                                        </button>
                                        <a class="navbar-brand" href="/">Dave Glick</a>
                                </div>
                        
                                <!-- Collect the nav links, forms, and other content for toggling -->
                                <div class="collapse navbar-collapse" id="navbar-collapse">
                                        <ul class="nav navbar-nav navbar-right">
                                                <li><a href="http://wyam.io/">Wyam</a></li>
                                                <li><a href="http://fluentbootstrap.com/">FluentBootstrap</a></li>
                                                <li><a class="hidden-xs">|</a><a class="visible-xs-block">-</a></li>
                                                <li><a href="/about">About</a></li>
                                                <li><a href="/posts">Archive</a></li>
                                                <li><a href="/tags">Tags</a></li>
                                        </ul>
                                </div>
                                <!-- /.navbar-collapse -->
                        </div>
                        <!-- /.container -->
                </nav>
                
                <!-- Page Header -->
                <header class="intro-header" id="intro-header">
                        <div class="container">
                                <div class="row">
                                        <div class="col-md-12">

    <div class="post-heading">
        <h1>Debugging Stack Overflows on IIS</h1>
            <h2 class="subheading">1990 called and they want their debugger back.</h2>
        <div class="meta">        
                Published on Tuesday, January 13, 2015<br>
                    </div>
            <div class="tags">

<a role="button" href="/tags/asp.net" class="btn btn-default btn-sm"> ASP.NET</a>
<a role="button" href="/tags/debugging" class="btn btn-default btn-sm"> debugging</a>
<a role="button" href="/tags/iis" class="btn btn-default btn-sm"> IIS</a>            </div>     
    </div>
                                        </div>
                                </div>
                        </div>
                </header>
                
                <!-- Main Content -->
                <div class="container">
                        <div class="row">
                                <div class="col-md-12">
                                        




<p>I recently had a problem with an ASP.NET application on IIS where IIS would kill my Application Pool process whenever a specific query was executed. There was no warning and while I could see the process disappear from my logging tool in real-time, I didn't get any error messages or exceptions. Thus began an epic adventure of debugging rules, crash dumps, and WinDbg. It's worth noting that I really have no idea what I'm doing here. Like most modern .NET developers I gave up this sort of thing years ago in favor of the debugging available through Visual Studio and other modern tools. However, it turns out that the only way to get detailed information in cases where IIS kills your process is to do it the hard way. There's probably also multiple hard ways to do it - this is just the one that worked well for me. Hopefully this saves you some time should you ever need to follow me down the rabbit hole.</p>


<h2>Check The Event Logs</h2>

<p>Before you start the process of getting crash dumps, etc. it might be helpful to check out the Windows Event Log. This should give you some small indication of what's going on, or at least give you something to Google. In my case I didn't have anything in the Application log, but in the System log I found an Information message with a source of Application Popup every time my process got killed:</p>

<pre class='prettyprint'>Application popup: w3wp.exe - System Error : A new guard page for the stack cannot be created.</pre>

<p>I also had a Warning from the source WAS:</p>

<pre class='prettyprint'>A process serving application pool &#39;MyAppPool&#39; suffered a fatal communication error with the Windows Process Activation Service. The process id was &#39;5288&#39;. The data field contains the error number.</pre>

<p>These two messages gave me enough for a search and pointed me in the right direction. In this case all signs pointed to a stack overflow, but your specific Event Log messages might indicate something different.</p>


<h2>Enable Debugging Rules</h2>

<p>The next step is to enable debugging rules to generate crash dumps. You'll need the Debug Diagnostic Tool for this part, which <a href="http://www.microsoft.com/en-us/download/details.aspx?id=42933">can be obtained here</a>. Once you've installed it, you'll need to restart IIS with a <code>iisreset</code> command from the command prompt. Then launch the Debug Diagnostic Tool and walk through the wizard for setting up debugging rules. This essentially creates watchers for various events and then takes various actions (such as dumping logs) when they occur. Specifically you want to create a crash rule:</p>


<img src="/Content/posts/debug-diagnostic-1.png" class="img-responsive">

<img src="/Content/posts/debug-diagnostic-2.png" class="img-responsive">

<p>Then when you get to the Advanced Configuration page, click on Exceptions and then Add Exception. This will let you select from a list of exceptions including Stack Overflow. Also make sure to change the Action Type to Full Userdump:</p>


<img src="/Content/posts/debug-diagnostic-3.png" class="img-responsive">

<p>Finally, select a location for the log files. Make sure it's got plenty of space because the files can get pretty big.</p>


<h2>Open The Dump In WinDbg</h2>

<p>Now run your application until it crashes. You should get some large <code>.dmp</code> files in the folder you selected during the wizard. For the next part you'll need to obtain WinDbg. It's important to get the version that matches the build profile of your application, not your system. So if your ASP.NET application is built for x86, you should get the x86 WinDbg tool even if your server is x64. The raw installers can be obtained <a href="http://rxwen-blog-stuff.googlecode.com/files/windbg_6.12.0002.633_x86.zip">here for x86</a> and <a href="http://rxwen-blog-stuff.googlecode.com/files/windbg_6.12.0002.633_64_installer.zip">here for x64</a>.</p>

<p>Once you install WinDbg, open it up and select Open Crash Dump from the File menu. Then you'll need to type the following two commands into the crash dump window:</p>

<pre class='prettyprint'>.loadby sos clr
!clrstack</pre>

<p>If everything goes well, this should print out the full stack when the process crashed (it might take a while). That should get you on your way to debugging what went wrong.</p>


<h2>Additional Resources</h2>

<p>In the course of trying to figure all of this out I came across some valuable resources:</p>

<ul class="p">
    <li><a href="http://stackoverflow.com/questions/5053708/how-to-debug-w3wp-exe-process-was-terminated-due-to-a-stack-overflow-works-on">This Stack Overflow question</a> got the ball rolling.</li>
    <li><a href="http://blog.whitesites.com/Debugging-Faulting-Application-w3wp-exe-Crashes__634424707278896484_blog.htm">This blog post</a> gives some good information about what to do once you get the crash dump loaded in WinDbg.</li>
    <li><a href="https://support.microsoft.com/kb/919789?wa=wsignin1.0">This Microsoft support page</a> has some step-by-step instructions for configuring Debug Diagnostic Tool in different environments.</li>
    <li><a href="http://geekswithblogs.net/.NETonMyMind/archive/2006/03/14/72262.aspx">This blog post</a> has a good reference on the commands that are available in WinDbg.</li>
</ul>

<div id="disqus_thread"></div>
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'somedave'; // required: replace example with your forum shortname
    var disqus_identifier = 'debugging-stack-overflows-on-iis';
    var disqus_title = 'Debugging Stack Overflows on IIS';
    var disqus_url = 'http://www.daveaglick.com/posts/debugging-stack-overflows-on-iis';

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>    

                                </div>
                        </div>
                </div>
                
                <hr>
                
                <!-- Footer -->
                <footer>
                        <div class="container">
                                <div class="row">
                                        <div class="col-md-12">
                                        <ul class="list-inline text-center">
                                                <li>
                                                <a href="https://twitter.com/daveaglick">
                                                        <span class="fa-stack fa-lg">
                                                        <i class="fa fa-circle fa-stack-2x"></i>
                                                        <i class="fa fa-twitter fa-stack-1x fa-inverse"></i>
                                                        </span>
                                                </a>
                                                </li>
                                                <li>
                                                <a href="https://github.com/daveaglick">
                                                        <span class="fa-stack fa-lg">
                                                        <i class="fa fa-circle fa-stack-2x"></i>
                                                        <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                                                        </span>
                                                </a>
                                                </li>
                                        </ul>
                                        <p class="copyright text-muted">
                                                Copyright © 2016 by Dave Glick. All jams and jellies preserved. The opinions expressed herein are my own and do not represent those of my employer or any other third-party views in any way. This work is licensed under a <a href="http://creativecommons.org/licenses/by/4.0/" rel="license">Creative Commons Attribution 4.0 International License</a>.
                                                <br />
                                                <a href="/feed.rss"><i class="fa fa-rss"></i> RSS Feed</a> | <a href="/feed.atom"><i class="fa fa-rss"></i> Atom Feed</a>
                                                <br />
                                                <a href="https://github.com/daveaglick/daveaglick"><i class="fa fa-github"></i> This Site on GitHub</a> | <strong><a href="http://wyam.io">Generated by Wyam</a></strong>
                                        </p>
                                        </div>
                                </div>
                        </div>
                </footer> 
        
                <script type="text/javascript">
                        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
                        var disqus_shortname = 'somedave'; // required: replace example with your forum shortname
                
                        /* * * DON'T EDIT BELOW THIS LINE * * */
                        (function () {
                                var s = document.createElement('script'); s.async = true;
                                s.type = 'text/javascript';
                                s.src = '//' + disqus_shortname + '.disqus.com/count.js';
                                (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
                        }());
                
                        // Google Analytics
                        (function (i, s, o, g, r, a, m) {
                                i['GoogleAnalyticsObject'] = r; i[r] = i[r] || function () {
                                (i[r].q = i[r].q || []).push(arguments)
                                }, i[r].l = 1 * new Date(); a = s.createElement(o),
                                m = s.getElementsByTagName(o)[0]; a.async = 1; a.src = g; m.parentNode.insertBefore(a, m)
                        })(window, document, 'script', '//www.google-analytics.com/analytics.js', 'ga');
                
                        ga('create', 'UA-54470483-1', 'auto');
                        ga('send', 'pageview');
                
                        // Background                        
                        var colors = Please.make_color({
                                colors_returned: 3,
                                saturation: .6
                        });
                        var t = new Trianglify({
                                x_gradient: colors,
                                y_gradient: ["#FFFFFF"]
                        });
                        var header = document.getElementById("intro-header");
                        var pattern = t.generate(header.clientWidth, header.clientHeight);
                        header.setAttribute('style', 'background-image: ' + pattern.dataUrl);                        
                </script>
        </body>
</html>

