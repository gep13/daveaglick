


<!DOCTYPE html>
<html lang="en">
	<head>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=Edge"/>

	<title>Dave Glick - Nested Grabs In GtkSharp</title>
        <meta name="description" content="The personal blog of Dave Glick" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0">        

        <link type="application/rss+xml" rel="alternate" title="Dave Glick" href="/feed.rss" />
        <link type="application/atom+xml" rel="alternate" title="Dave Glick" href="/feed.atom" />
        <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
        <link rel="icon" href="/favicon.ico" type="image/x-icon">
        <link rel="icon" type="image/png" href="/favicon-32x32.png" sizes="32x32" />
        <link rel="icon" type="image/png" href="/favicon-16x16.png" sizes="16x16" />

        <link href="/Content/bootstrap/bootstrap.css" rel="stylesheet" />
        <link href="/Content/prettify.css" rel="stylesheet">
        <link href="/Content/github.css" rel="stylesheet">
        <link href="/Content/master.css" rel="stylesheet" />

        <meta name="application-name" content="Dave Glick" />
        <meta name="msapplication-tooltip" content="Dave Glick" />
        <meta name="msapplication-starturl" content="/" />

        <meta property="og:title" content="Dave Glick - Nested Grabs In GtkSharp" />
        
        <meta property="og:type" content="website" />
        <meta property="og:url" content="http://daveaglick.com/posts/nested-grabs-in-gtksharp" />
        <!-- TODO: More social graph meta tags -->

        <script src="/Scripts/jquery-2.1.1.min.js"></script>
        <script src="/Scripts/bootstrap.min.js"></script>     
        <script src="/Scripts/prettify.js"></script>
        <script src="http://d3js.org/d3.v3.min.js"></script>
        <script src="/Scripts/trianglify.min.js"></script>
        <script src="/Scripts/Please-compressed.js"></script>
        <script src="//ajax.googleapis.com/ajax/libs/webfont/1.4.7/webfont.js"></script>
        <script>
            WebFont.load({
                google: {
                    families: ['Lato:400,900:latin', 'Droid+Serif::latin']
                },
                custom: {
                    families: ['daveaglick'],
                    urls: ['https://fontastic.s3.amazonaws.com/gfxCC547kHqmQZtxrW5KFY/icons.css']
                }
            });
        </script>
	</head>
	<body onload="prettyPrint()">

<div id="page-wrapper">
 <div class="container topnav container-sm-height">
  <div class="row nav-row row-sm-height">
   <div class="col-xs-3 col-sm-6 logo-col col-sm-height col-bottom">                        <a href="/">Dave Glick</a>
</div>
   <div class="col-xs-9 visible-xs-block">
    <div class="visible-xs-block">                            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".collapse">
                                <span class="icon-bar"></span>
                                <span class="icon-bar"></span>
                                <span class="icon-bar"></span>
                            </button>
</div>
   </div>
   <div class="clearfix visible-xs-block"></div>
   <div class="col-xs-12 col-sm-2 nav-col collapse col-sm-height" style="visibility: visible;">
    <ul class="list-unstyled">
     <li>/ <a href="/about"> About</a></li>
     <li>/ <a href="/posts"> Archive</a></li>
     <li>/ <a href="/tags"> Tags</a></li>
     <li>/ <a href="/likes"> Likes</a></li>
    </ul>                        <a class="twitter-follow-button" href="https://twitter.com/daveaglick" data-show-count="false" data-lang="en">Follow @daveaglick</a>

   </div>
   <div class="clearfix visible-xs-block"></div>
   <div class="col-xs-12 col-sm-4 proj-col collapse col-sm-height" style="visibility: visible;">
    <div>Projects</div>
    <ul class="list-unstyled">
     <li>/ <a href="http://wyam.io">Wyam</a></li>
     <li>/ <a href="http://fluentbootstrap.com">FluentBootstrap</a></li>
     <li>/ <a href="https://github.com/daveaglick/LINQPad.CodeAnalysis">LINQPad.CodeAnalysis</a></li>
     <li>/ <a href="/razordatabase">RazorDatabase</a></li>
    </ul>
   </div>
  </div>
 </div>
 <div id="body-content" class="container">
  <div class="row">
   <div class="col-md-12">



<div class="banner container-sm-height">
 <div class="row row-sm-height">
  <div class="col-sm-8 col-sm-height col-bottom">            <div class="title">Nested Grabs In GtkSharp</div>
</div>
  <div class="col-sm-4 col-sm-height col-bottom stats">
   <div class="row">
    <div class="col-sm-12">                    <hr class="visible-xs-block" />
                        <div><strong>Tags</strong></div>
                        <div>

     <a role="button" href="/tags/gtksharp" class="btn btn-default btn-sm tag-button icon-tag-2"> GtkSharp</a>
     <a role="button" href="/tags/mono" class="btn btn-default btn-sm tag-button icon-tag-2"> Mono</a>                        </div>     
                        <div><strong>Published</strong></div>
                        <div class="icon-calendar"> &nbsp;Thursday, April 15, 2010</div>
                    <div><strong>Comments</strong></div>
                    <div class="icon-talk-chat-2"> &nbsp;<a href="#disqus_thread" data-disqus-identifier="nested-grabs-in-gtksharp"></a></div>               
                    <div><a class="twitter-share-button" href="https://twitter.com/share" data-url="http://www.daveaglick.com/posts/nested-grabs-in-gtksharp" data-via="daveaglick" data-text="Nested Grabs In GtkSharp" data-count="none">Tweet</a></div>

    </div>
   </div>
  </div>
 </div>
</div>
<hr />

<div class="row">
 <div id="post-content" class="col-sm-12">
<p>I ran across this while working on some complex GtkSharp grabbing behavior to mimic window focusing for a docking framework. Turns out there is a weird inconsistency in the way Gtk+ manages the grab stack. While the list of grabbed Widgets is indeed a stack, a flag on each Widget (<code>Widget.HasGrab</code>) is used to check if a Widget has the grab or not. The problem is that <code>Grab.Add</code> (which calls the Gtk+ method <code><a href="http://library.gnome.org/devel/gtk/stable/gtk-General.html#gtk-grab-add">gtk_grab_add</a></code>) never clears the flag for the currently grabbed Widget if you're nesting grabs. That means that <em>every Widget in the grab stack</em> will have <code>Widget.HasGrab</code> set to true. If you try to add a Widget to the grab stack and it's already in the stack (even if there are multiple other grabbed Widgets after it in the stack), it won't get added. Because the flag is set though, it <em>will</em> get removed at the first place it was in the stack on a call to <code>Grab.Remove</code> (<code><a href="http://library.gnome.org/devel/gtk/stable/gtk-General.html#gtk-grab-remove">gtk_grab_remove</a></code>).</p>

<p>While it may not be a bug, this is certainly odd behavior. The solution (at least for me) was to write two small utility methods. <code>SafeAdd</code> first removes the <code>Widget.HasGrab</code> flag to ensure that the Widget always gets added to the grab stack, regardless of if it's previously in it. <code>SafeAdd</code> should be paired with <code>SafeRemove</code> which checks the newly grabbed Widget after removing one to make sure it still has the <code>Widget.HasGrab</code> flag set. Note that it doesn't clear the <code>Widget.HasGrab</code> flag for grabbed Widget getting replaced by a new grabbed Widget on the grab stack as you might expect. This maintains compatibility with all the other Gtk code that might be expecting Widgets anywhere in the stack to have the flag set.</p>

<pre class="prettyprint">public static void SafeAdd(Widget widget)
{
 if (widget == null)
 {
  throw new ArgumentNullException("widget");
 }
 if (widget.Sensitive)
 {
  widget.ClearFlag(WidgetFlags.HasGrab);
  Grab.Add(widget);
 }
}

public static void SafeRemove(Widget widget)
{
 if (widget == null)
 {
  throw new ArgumentNullException("widget");
 }
 Grab.Remove(widget);
 Widget current = Grab.Current;
 if( current != null && !current.HasGrab )
 {
  current.SetFlag(WidgetFlags.HasGrab);
 }
}</pre>
</div>
</div>
<hr />

<div class="row">
 <div class="col-sm-12">        <div id="disqus_thread"></div>
        <script type="text/javascript">
            /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
            var disqus_shortname = 'somedave'; // required: replace example with your forum shortname
            var disqus_identifier = 'nested-grabs-in-gtksharp';
            var disqus_title = 'Nested Grabs In GtkSharp';
            var disqus_url = 'http://www.daveaglick.com/posts/nested-grabs-in-gtksharp';

            /* * * DON'T EDIT BELOW THIS LINE * * */
            (function() {
                var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
                dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
                (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
            })();
        </script>
        <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
        <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>    
</div>
</div></div>
  </div>
 </div>
</div>        
<div id="sticky-footer-wrapper">
 <div id="sticky-footer">
  <div class="container">
   <small>                        
                            Copyright © 2015 by Dave Glick. All jams and jellies preserved. The opinions expressed herein are my own and do not represent those of my employer or any other third-party views in any way. This work is licensed under a
                            <a href="http://creativecommons.org/licenses/by/4.0/" rel="license">
    <span class="icon-creative-commons"></span> Creative Commons Attribution 4.0 International License</a>.
                            <br />
                            <a href="/feed.rss">
    <span class="icon-rss"></span> RSS Feed</a> | <a href="/feed.atom">
    <span class="icon-rss"></span> Atom Feed</a>
                            <br />
                            <a href="https://github.com/daveaglick/daveaglick">
    <span class="icon-github-square"></span> This Site on GitHub</a> | <strong><a href="http://wyam.io">Generated by Wyam</a></strong>
                        

   </small>
  </div>
 </div>
</div>
        <script type="text/javascript">
            /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
            var disqus_shortname = 'somedave'; // required: replace example with your forum shortname

            /* * * DON'T EDIT BELOW THIS LINE * * */
            (function () {
                var s = document.createElement('script'); s.async = true;
                s.type = 'text/javascript';
                s.src = '//' + disqus_shortname + '.disqus.com/count.js';
                (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
            }());

            // Google Analytics
            (function (i, s, o, g, r, a, m) {
                i['GoogleAnalyticsObject'] = r; i[r] = i[r] || function () {
                    (i[r].q = i[r].q || []).push(arguments)
                }, i[r].l = 1 * new Date(); a = s.createElement(o),
                m = s.getElementsByTagName(o)[0]; a.async = 1; a.src = g; m.parentNode.insertBefore(a, m)
            })(window, document, 'script', '//www.google-analytics.com/analytics.js', 'ga');

            ga('create', 'UA-54470483-1', 'auto');
            ga('send', 'pageview');

            // Twitter
            window.twttr = (function (d, s, id) {
                var t, js, fjs = d.getElementsByTagName(s)[0];
                if (d.getElementById(id)) return;
                js = d.createElement(s); js.id = id;
                js.src = "https://platform.twitter.com/widgets.js";
                fjs.parentNode.insertBefore(js, fjs);
                return window.twttr || (t = { _e: [], ready: function (f) { t._e.push(f) } });
            }(document, "script", "twitter-wjs"));

            // Background
            var colors = Please.make_color({
                golden: false,
                colors_returned: 3,
                saturation: .4
            });
            var t = new Trianglify({
                x_gradient: colors,
                y_gradient: ["#FFFFFF"]
            });
            var pattern = t.generate(document.body.clientWidth, document.body.clientHeight);
            document.body.setAttribute('style', 'background-image: ' + pattern.dataUrl);
        </script>
	</bodyonload="prettyPrint()">
</html>

