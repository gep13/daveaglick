


<!DOCTYPE html>
<html lang="en">
	<head>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=Edge"/>

	<title>Dave Glick - Exporting a GtkSharp TreeView to CSV</title>
        <meta name="description" content="The personal blog of Dave Glick" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0">        

        <link type="application/rss+xml" rel="alternate" title="Dave Glick" href="/feed.rss" />
        <link type="application/atom+xml" rel="alternate" title="Dave Glick" href="/feed.atom" />
        <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
        <link rel="icon" href="/favicon.ico" type="image/x-icon">
        <link rel="icon" type="image/png" href="/favicon-32x32.png" sizes="32x32" />
        <link rel="icon" type="image/png" href="/favicon-16x16.png" sizes="16x16" />

        <link href="/Content/bootstrap/bootstrap.css" rel="stylesheet" />
        <link href="/Content/prettify.css" rel="stylesheet">
        <link href="/Content/github.css" rel="stylesheet">
        <link href="/Content/master.css" rel="stylesheet" />

        <meta name="application-name" content="Dave Glick" />
        <meta name="msapplication-tooltip" content="Dave Glick" />
        <meta name="msapplication-starturl" content="/" />

        <meta property="og:title" content="Dave Glick - Exporting a GtkSharp TreeView to CSV" />
        
        <meta property="og:type" content="website" />
        <meta property="og:url" content="http://daveaglick.com/posts/exporting-a-gtksharp-treeview-to-csv" />
        <!-- TODO: More social graph meta tags -->

        <script src="/Scripts/jquery-2.1.1.min.js"></script>
        <script src="/Scripts/bootstrap.min.js"></script>     
        <script src="/Scripts/prettify.js"></script>
        <script src="http://d3js.org/d3.v3.min.js"></script>
        <script src="/Scripts/trianglify.min.js"></script>
        <script src="/Scripts/Please-compressed.js"></script>
        <script src="//ajax.googleapis.com/ajax/libs/webfont/1.4.7/webfont.js"></script>
        <script>
            WebFont.load({
                google: {
                    families: ['Lato:400,900:latin', 'Droid+Serif::latin']
                },
                custom: {
                    families: ['daveaglick'],
                    urls: ['https://fontastic.s3.amazonaws.com/gfxCC547kHqmQZtxrW5KFY/icons.css']
                }
            });
        </script>
	</head>
	<body onload="prettyPrint()">

<div id="page-wrapper">
 <div class="container topnav container-sm-height">
  <div class="row nav-row row-sm-height">
   <div class="col-xs-3 col-sm-6 logo-col col-sm-height col-bottom">                        <a href="/">Dave Glick</a>
</div>
   <div class="col-xs-9 visible-xs-block">
    <div class="visible-xs-block">                            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".collapse">
                                <span class="icon-bar"></span>
                                <span class="icon-bar"></span>
                                <span class="icon-bar"></span>
                            </button>
</div>
   </div>
   <div class="clearfix visible-xs-block"></div>
   <div class="col-xs-12 col-sm-2 nav-col collapse col-sm-height" style="visibility: visible;">
    <ul class="list-unstyled">
     <li>/ <a href="/about"> About</a></li>
     <li>/ <a href="/posts"> Archive</a></li>
     <li>/ <a href="/tags"> Tags</a></li>
     <li>/ <a href="/likes"> Likes</a></li>
    </ul>                        <a class="twitter-follow-button" href="https://twitter.com/daveaglick" data-show-count="false" data-lang="en">Follow @daveaglick</a>

   </div>
   <div class="clearfix visible-xs-block"></div>
   <div class="col-xs-12 col-sm-4 proj-col collapse col-sm-height" style="visibility: visible;">
    <div>Projects</div>
    <ul class="list-unstyled">
     <li>/ <a href="http://wyam.io">Wyam</a></li>
     <li>/ <a href="http://fluentbootstrap.com">FluentBootstrap</a></li>
     <li>/ <a href="https://github.com/daveaglick/LINQPad.CodeAnalysis">LINQPad.CodeAnalysis</a></li>
     <li>/ <a href="/razordatabase">RazorDatabase</a></li>
    </ul>
   </div>
  </div>
 </div>
 <div id="body-content" class="container">
  <div class="row">
   <div class="col-md-12">



<div class="banner container-sm-height">
 <div class="row row-sm-height">
  <div class="col-sm-8 col-sm-height col-bottom">            <div class="title">Exporting a GtkSharp TreeView to CSV</div>
                <div class="lead">All packaged up in nice little utility methods.</div>
</div>
  <div class="col-sm-4 col-sm-height col-bottom stats">
   <div class="row">
    <div class="col-sm-12">                    <hr class="visible-xs-block" />
                        <div><strong>Tags</strong></div>
                        <div>

     <a role="button" href="/tags/cellrenderer" class="btn btn-default btn-sm tag-button icon-tag-2"> CellRenderer</a>
     <a role="button" href="/tags/csv" class="btn btn-default btn-sm tag-button icon-tag-2"> CSV</a>
     <a role="button" href="/tags/gtksharp" class="btn btn-default btn-sm tag-button icon-tag-2"> GtkSharp</a>
     <a role="button" href="/tags/mono" class="btn btn-default btn-sm tag-button icon-tag-2"> Mono</a>
     <a role="button" href="/tags/treemodel" class="btn btn-default btn-sm tag-button icon-tag-2"> TreeModel</a>
     <a role="button" href="/tags/treeview" class="btn btn-default btn-sm tag-button icon-tag-2"> TreeView</a>
     <a role="button" href="/tags/treeviewcolumn" class="btn btn-default btn-sm tag-button icon-tag-2"> TreeViewColumn</a>                        </div>     
                        <div><strong>Published</strong></div>
                        <div class="icon-calendar"> &nbsp;Friday, April 9, 2010</div>
                    <div><strong>Comments</strong></div>
                    <div class="icon-talk-chat-2"> &nbsp;<a href="#disqus_thread" data-disqus-identifier="exporting-a-gtksharp-treeview-to-csv"></a></div>               
                    <div><a class="twitter-share-button" href="https://twitter.com/share" data-url="http://www.daveaglick.com/posts/exporting-a-gtksharp-treeview-to-csv" data-via="daveaglick" data-text="Exporting a GtkSharp TreeView to CSV" data-count="none">Tweet</a></div>

    </div>
   </div>
  </div>
 </div>
</div>
<hr />

<div class="row">
 <div id="post-content" class="col-sm-12"><p>I recently had to create some functionality to export a TreeView widget to a CSV file for further analysis. Since I tend to think about generic behavior, I decided to code up a method that would take any arbitrary TreeView and perform the export operation. Luckily, the TreeView widget and the attached TreeModel both contain a lot of functionality for accessing the data and it's presentation. I decided that I wanted the exported CSV file to represent the perspective of the model as currently represented in the TreeView including column visibility and sort order. This led to the trickiest part of the process. Because a CellRenderer can be customized using cell data functions (such as those added by a call to TreeViewColumn.SetCellDataFunc), I had to pull the content to export from the CellRenderer as opposed to pulling directly from the TreeModel. Turns out there's a method to take the TreeIter from a TreeModel and apply it to all the CellRenderers in a given TreeViewColumn. Since I really only care about textual content, I decided to only export those columns that contain CellRendererText renderers.</p>
<p>After working out the algorithm to fetch what needed to be exported I thought I was ready to roll. Turns out that the CSV pseudo-standard is pretty complex though (the RFC is <a href="http://www.rfc-editor.org/rfc/rfc4180.txt">here</a>), and I quickly got bogged down in writing all kinds of special cases for escaping, quoting, etc. Thankfully, someone else had already been down this road and I was able to find the excellent <a href="http://kbcsv.codeplex.com/">KBCsv</a> library which will write and read formatted CSV files. My only complaint was that it used another utility library purely for convenience in exception generation and null checking (I already use a ton of libraries in our application and I'd prefer not to add any unnecessarily). I replaced the calls to the utility library with the language equivalents, but that's totally a personal preference.</p>
<p>Without further adieu, I present the <code>TreeViewHelper.ExportToCsv</code> and <code>TreeViewHelper.ExportToCsvFile</code> methods...</p>
<pre class="prettyprint">using System;
using System.Collections.Generic;
using System.IO;
using Gtk;
using Kent.Boogaart.KBCsv;

namespace DaveAGlick
{
 public static class TreeViewHelper
 {
  public static bool ExportToCsv(TreeView treeView, Window parent)
  {
   FileChooserDialog fcd = new FileChooserDialog("Export File", parent, FileChooserAction.Save,
   "Cancel", ResponseType.Cancel, "Export", ResponseType.Accept);
   fcd.DoOverwriteConfirmation = true;
   FileFilter filter = new FileFilter { Name = "CSV File" };
   filter.AddPattern("*.csv");
   fcd.AddFilter(filter);
   if (fcd.Run() == (int)ResponseType.Accept)
   {
    string path = fcd.Filename;
    fcd.Destroy();
    return ExportToCsvFile(treeView, path);
   }
   fcd.Destroy();
   return false;
  }

  public static bool ExportToCsvFile(TreeView treeView, string path)
  {
   //Get the iterator
   TreeIter iter;
   if (treeView.Model.GetIterFirst(out iter))
   {
    //Create the stream
    using (StreamWriter streamWriter = new StreamWriter(path, false))
    {
     //Create the CSV writer
     using (CsvWriter csvWriter = new CsvWriter(streamWriter))
     {
      List&lt;string&gt; headers = new List&lt;string&gt;();
      List&lt;string&gt; values = new List&lt;string&gt;();

      //Traverse the tree
      do
      {
       values.Clear();
       foreach (TreeViewColumn column in treeView.Columns)
       {
        //Only output visible columns
        if (column.Visible)
        {
         //Loop through CellRenderers to make sure we have a CellRendererText
         string value = null;
         column.CellSetCellData(treeView.Model, iter, false, false);
         foreach (CellRenderer renderer in column.CellRenderers)
         {
          CellRendererText text = renderer as CellRendererText;
          if (text != null)
          {
           //Setting value indicates this column had a CellRendererText and should be included
           if (value == null)
           {
            value = String.Empty;
           }

           //Add the header if the first time through
           if (headers != null)
           {
            headers.Add(column.Title);
           }

           //Append to the value
           if (text.Text != null)
           {
            value += text.Text;
           }
          }
         }
         if (value != null)
         {
          values.Add(value);
         }
        }
       }

       //Output the header
       if (headers != null)
       {
        csvWriter.WriteHeaderRecord(headers.ToArray());
        headers = null;
       }

       //Output the values
       csvWriter.WriteDataRecord(values.ToArray());
      } while (treeView.Model.IterNext(ref iter));
     }
    }
    return true;
   }
   return false;
  }
 }
}
</pre>

</div>
</div>
<hr />

<div class="row">
 <div class="col-sm-12">        <div id="disqus_thread"></div>
        <script type="text/javascript">
            /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
            var disqus_shortname = 'somedave'; // required: replace example with your forum shortname
            var disqus_identifier = 'exporting-a-gtksharp-treeview-to-csv';
            var disqus_title = 'Exporting a GtkSharp TreeView to CSV';
            var disqus_url = 'http://www.daveaglick.com/posts/exporting-a-gtksharp-treeview-to-csv';

            /* * * DON'T EDIT BELOW THIS LINE * * */
            (function() {
                var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
                dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
                (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
            })();
        </script>
        <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
        <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>    
</div>
</div></div>
  </div>
 </div>
</div>        
<div id="sticky-footer-wrapper">
 <div id="sticky-footer">
  <div class="container">
   <small>                        
                            Copyright © 2015 by Dave Glick. All jams and jellies preserved. The opinions expressed herein are my own and do not represent those of my employer or any other third-party views in any way. This work is licensed under a
                            <a href="http://creativecommons.org/licenses/by/4.0/" rel="license">
    <span class="icon-creative-commons"></span> Creative Commons Attribution 4.0 International License</a>.
                            <br />
                            <a href="/feed.rss">
    <span class="icon-rss"></span> RSS Feed</a> | <a href="/feed.atom">
    <span class="icon-rss"></span> Atom Feed</a>
                            <br />
                            <a href="https://github.com/daveaglick/daveaglick">
    <span class="icon-github-square"></span> This Site on GitHub</a> | <strong><a href="http://wyam.io">Generated by Wyam</a></strong>
                        

   </small>
  </div>
 </div>
</div>
        <script type="text/javascript">
            /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
            var disqus_shortname = 'somedave'; // required: replace example with your forum shortname

            /* * * DON'T EDIT BELOW THIS LINE * * */
            (function () {
                var s = document.createElement('script'); s.async = true;
                s.type = 'text/javascript';
                s.src = '//' + disqus_shortname + '.disqus.com/count.js';
                (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
            }());

            // Google Analytics
            (function (i, s, o, g, r, a, m) {
                i['GoogleAnalyticsObject'] = r; i[r] = i[r] || function () {
                    (i[r].q = i[r].q || []).push(arguments)
                }, i[r].l = 1 * new Date(); a = s.createElement(o),
                m = s.getElementsByTagName(o)[0]; a.async = 1; a.src = g; m.parentNode.insertBefore(a, m)
            })(window, document, 'script', '//www.google-analytics.com/analytics.js', 'ga');

            ga('create', 'UA-54470483-1', 'auto');
            ga('send', 'pageview');

            // Twitter
            window.twttr = (function (d, s, id) {
                var t, js, fjs = d.getElementsByTagName(s)[0];
                if (d.getElementById(id)) return;
                js = d.createElement(s); js.id = id;
                js.src = "https://platform.twitter.com/widgets.js";
                fjs.parentNode.insertBefore(js, fjs);
                return window.twttr || (t = { _e: [], ready: function (f) { t._e.push(f) } });
            }(document, "script", "twitter-wjs"));

            // Background
            var colors = Please.make_color({
                golden: false,
                colors_returned: 3,
                saturation: .4
            });
            var t = new Trianglify({
                x_gradient: colors,
                y_gradient: ["#FFFFFF"]
            });
            var pattern = t.generate(document.body.clientWidth, document.body.clientHeight);
            document.body.setAttribute('style', 'background-image: ' + pattern.dataUrl);
        </script>
	</bodyonload="prettyPrint()">
</html>

