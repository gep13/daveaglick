


<!DOCTYPE html>
<html lang="en">
	<head>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=Edge"/>

	<title>Dave Glick - Using the .NET Compiler Platform in T4 Templates</title>
        <meta name="description" content="The personal blog of Dave Glick" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0">        

        <link type="application/rss+xml" rel="alternate" title="Dave Glick" href="/feed.rss" />
        <link type="application/atom+xml" rel="alternate" title="Dave Glick" href="/feed.atom" />
        <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
        <link rel="icon" href="/favicon.ico" type="image/x-icon">
        <link rel="icon" type="image/png" href="/favicon-32x32.png" sizes="32x32" />
        <link rel="icon" type="image/png" href="/favicon-16x16.png" sizes="16x16" />

        <link href="/Content/bootstrap/bootstrap.css" rel="stylesheet" />
        <link href="/Content/prettify.css" rel="stylesheet">
        <link href="/Content/github.css" rel="stylesheet">
        <link href="/Content/master.css" rel="stylesheet" />

        <meta name="application-name" content="Dave Glick" />
        <meta name="msapplication-tooltip" content="Dave Glick" />
        <meta name="msapplication-starturl" content="/" />

        <meta property="og:title" content="Dave Glick - Using the .NET Compiler Platform in T4 Templates" />
        
        <meta property="og:type" content="website" />
        <meta property="og:url" content="http://daveaglick.com/posts\compiler-platform-in-t4.cshtml" />
        <!-- TODO: More social graph meta tags -->

        <script src="/Scripts/jquery-2.1.1.min.js"></script>
        <script src="/Scripts/bootstrap.min.js"></script>     
        <script src="/Scripts/prettify.js"></script>
        <script src="http://d3js.org/d3.v3.min.js"></script>
        <script src="/Scripts/trianglify.min.js"></script>
        <script src="/Scripts/Please-compressed.js"></script>
        <script src="//ajax.googleapis.com/ajax/libs/webfont/1.4.7/webfont.js"></script>
        <script>
            WebFont.load({
                google: {
                    families: ['Lato:400,900:latin', 'Droid+Serif::latin']
                },
                custom: {
                    families: ['daveaglick'],
                    urls: ['https://fontastic.s3.amazonaws.com/gfxCC547kHqmQZtxrW5KFY/icons.css']
                }
            });
        </script>
	</head>
	<body onload="prettyPrint()">

<div id="page-wrapper">
 <div class="container topnav container-sm-height">
  <div class="row nav-row row-sm-height">
   <div class="col-xs-3 col-sm-6 logo-col col-sm-height col-bottom">                        <a href="/">Dave Glick</a>
</div>
   <div class="col-xs-9 visible-xs-block">
    <div class="visible-xs-block">                            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".collapse">
                                <span class="icon-bar"></span>
                                <span class="icon-bar"></span>
                                <span class="icon-bar"></span>
                            </button>
</div>
   </div>
   <div class="clearfix visible-xs-block"></div>
   <div class="col-xs-12 col-sm-2 nav-col collapse col-sm-height" style="visibility: visible;">
    <ul class="list-unstyled">
     <li>/ <a href="/about"> About</a></li>
     <li>/ <a href="/posts"> Archive</a></li>
     <li>/ <a href="/tags"> Tags</a></li>
     <li>/ <a href="/likes"> Likes</a></li>
    </ul>                        <a class="twitter-follow-button" href="https://twitter.com/daveaglick" data-show-count="false" data-lang="en">Follow @daveaglick</a>

   </div>
   <div class="clearfix visible-xs-block"></div>
   <div class="col-xs-12 col-sm-4 proj-col collapse col-sm-height" style="visibility: visible;">
    <div>Projects</div>
    <ul class="list-unstyled">
     <li>/ <a href="http://wyam.io">Wyam</a></li>
     <li>/ <a href="http://fluentbootstrap.com">FluentBootstrap</a></li>
     <li>/ <a href="https://github.com/daveaglick/LINQPad.CodeAnalysis">LINQPad.CodeAnalysis</a></li>
     <li>/ <a href="/razordatabase">RazorDatabase</a></li>
    </ul>
   </div>
  </div>
 </div>
 <div id="body-content" class="container">
  <div class="row">
   <div class="col-md-12">



<div class="banner container-sm-height">
 <div class="row row-sm-height">
  <div class="col-sm-8 col-sm-height col-bottom">            <div class="title">Using the .NET Compiler Platform in T4 Templates</div>
                <div class="lead">Metaprogramming with Roslyn.</div>
</div>
  <div class="col-sm-4 col-sm-height col-bottom stats">
   <div class="row">
    <div class="col-sm-12">                    <hr class="visible-xs-block" />
                        <div><strong>Tags</strong></div>
                        <div>

     <a role="button" href="/tags/net-compiler-platform" class="btn btn-default btn-sm tag-button icon-tag-2"> .NET Compiler Platform</a>
     <a role="button" href="/tags/roslyn" class="btn btn-default btn-sm tag-button icon-tag-2"> Roslyn</a>
     <a role="button" href="/tags/t4" class="btn btn-default btn-sm tag-button icon-tag-2"> T4</a>
     <a role="button" href="/tags/templating" class="btn btn-default btn-sm tag-button icon-tag-2"> templating</a>                        </div>     
                        <div><strong>Published</strong></div>
                        <div class="icon-calendar"> &nbsp;Thursday, April 23, 2015</div>
                    <div><strong>Comments</strong></div>
                    <div class="icon-talk-chat-2"> &nbsp;<a href="#disqus_thread" data-disqus-identifier="compiler-platform-in-t4"></a></div>               
                    <div><a class="twitter-share-button" href="https://twitter.com/share" data-url="http://www.daveaglick.com/posts/compiler-platform-in-t4" data-via="daveaglick" data-text="Using the .NET Compiler Platform in T4 Templates" data-count="none">Tweet</a></div>

    </div>
   </div>
  </div>
 </div>
</div>
<hr />

<div class="row">
 <div id="post-content" class="col-sm-12">
<p><a href="https://msdn.microsoft.com/en-us/library/bb126445.aspx">T4 templates</a> provide a powerful way to generate code at design time (and sometimes at compile time if you set up Visual Studio appropriately). The traditional way of accessing the code of your solution from within a T4 template is to <a href="https://msdn.microsoft.com/en-us/library/vstudio/gg604090(v=vs.100).aspx">get the Visual Studio API</a> (called <a href="https://msdn.microsoft.com/en-us/library/vstudio/envdte.dte(v=vs.100).aspx">DTE</a>). This has always seemed like a bit of a kludge to me and feels a little too far removed from the code and what it represents. We now have another option by using the .NET Compiler Platform from within a T4 template to parse, query, and output content based on the files in our solution.</p>

<p>In my particular case I wanted to scan all the source files in the same folder as the template, look for classes that derive from a specific base class (
<code>Module</code>), iterate over all their public constructors, and then output extension methods for the 
<code>IPipeline</code> interface for each constructor that instantiates the class using that constructor and adds it to the pipeline. Here's what the template looks like:</p>


<pre class='prettyprint'>&lt;#@ template debug=&quot;false&quot; hostspecific=&quot;true&quot; language=&quot;C#&quot; #&gt;
&lt;#@ assembly name=&quot;System.Core&quot; #&gt;
&lt;#@ assembly name=&quot;System.IO&quot; #&gt;
&lt;#@ assembly name=&quot;System.Runtime&quot; #&gt;
&lt;#@ assembly name=&quot;System.Text.Encoding&quot; #&gt;
&lt;#@ assembly name=&quot;System.Threading.Tasks&quot; #&gt;
&lt;#@ assembly name=&quot;$(TargetDir)Microsoft.CodeAnalysis.dll&quot; #&gt;
&lt;#@ assembly name=&quot;$(TargetDir)Microsoft.CodeAnalysis.CSharp.dll&quot; #&gt;
&lt;#@ assembly name=&quot;$(TargetDir)System.Collections.Immutable.dll&quot; #&gt;
&lt;#@ import namespace=&quot;System.Linq&quot; #&gt;
&lt;#@ import namespace=&quot;System.Text&quot; #&gt;
&lt;#@ import namespace=&quot;System.Collections.Generic&quot; #&gt;
&lt;#@ import namespace=&quot;System.IO&quot; #&gt;
&lt;#@ import namespace=&quot;Microsoft.CodeAnalysis&quot; #&gt;
&lt;#@ import namespace=&quot;Microsoft.CodeAnalysis.CSharp&quot; #&gt;
&lt;#@ import namespace=&quot;Microsoft.CodeAnalysis.CSharp.Syntax&quot; #&gt;
&lt;#@ output extension=&quot;.cs&quot; #&gt;
using System;
using System.Collections.Generic;
using System.IO;

&lt;# Process(); #&gt;
&lt;#+
	public void Process()
	{
		// Get a SyntaxTree for every file
		foreach(CSharpSyntaxTree syntaxTree in Directory.EnumerateFiles(Path.GetDirectoryName(Host.TemplateFile))
			.Where(x =&gt; Path.GetExtension(x) == &quot;.cs&quot;)
			.Select(x =&gt; CSharpSyntaxTree.ParseText(File.ReadAllText(x)))
			.Cast&lt;CSharpSyntaxTree&gt;())
		{
			// Get all class declarations in each file that derive from Module
			foreach(ClassDeclarationSyntax classDeclaration in syntaxTree.GetRoot()
				.DescendantNodes()
				.OfType&lt;ClassDeclarationSyntax&gt;()
				.Where(x =&gt; x.BaseList != null &amp;&amp; x.BaseList.Types
					.Any(y =&gt; y.Type is Microsoft.CodeAnalysis.CSharp.Syntax.IdentifierNameSyntax 
						&amp;&amp; ((Microsoft.CodeAnalysis.CSharp.Syntax.IdentifierNameSyntax)y.Type).Identifier.Text == &quot;Module&quot;)))
			{
				// Output the same namespace as the class
				SyntaxNode namespaceNode = classDeclaration.Parent;
				while(namespaceNode != null &amp;&amp; !(namespaceNode is NamespaceDeclarationSyntax))
				{
					namespaceNode = namespaceNode.Parent;
				}
				if(namespaceNode != null)
				{
					WriteLine(&quot;namespace &quot; + ((NamespaceDeclarationSyntax)namespaceNode).Name.ToString() + Environment.NewLine + &quot;{&quot;);
				}
			
				// Output the extensions class
				WriteLine(&quot;    public static class &quot; + classDeclaration.Identifier.Text + &quot;PipelineExtensions&quot; + Environment.NewLine + &quot;    {&quot;);
			
				// Get all non-static public constructors
				foreach(ConstructorDeclarationSyntax constructor in classDeclaration.Members
					.OfType&lt;ConstructorDeclarationSyntax&gt;()
					.Where(x =&gt; x.Modifiers.Count == 1 &amp;&amp; x.Modifiers[0].Text == &quot;public&quot;))
				{
					// Output the static constructor method
					WriteLine(&quot;        public static IPipeline &quot; + classDeclaration.Identifier.Text + constructor.ParameterList.ToString().Insert(1, &quot;this IPipeline pipeline, &quot;) + Environment.NewLine + &quot;        {&quot;);
				
					// Create and add the module
					WriteLine(&quot;            return pipeline.AddModule(new &quot; + classDeclaration.Identifier.Text + &quot;(&quot; + string.Join(&quot;, &quot;, constructor.ParameterList.Parameters.Select(x =&gt; x.Identifier.Text)) + &quot;));&quot;);
				
					// Close method
					WriteLine(&quot;        }&quot;);
				}
			
				// Close extensions class
				WriteLine(&quot;    }&quot;);			
			
				// Close namespace
				if(namespaceNode != null)
				{
					WriteLine(&quot;}&quot;);
				}
			}
		}
	}
#&gt;</pre>

<p>And this is some example output:</p>

<pre class='prettyprint'>using System;
using System.Collections.Generic;
using System.IO;

namespace Wyam.Core.Modules
{
    public static class AppendPipelineExtensions
    {
        public static IPipeline Append(this IPipeline pipeline, string content)
        {
            return pipeline.AddModule(new Append(content));
        }
    }
}</pre>

<p>A couple things to note:</p>


<ul class="p">
 <li>You must use the Roslyn assemblies from NuGet. If you try to build them yourself, they won't work out of the box in a T4 template because of the way Roslyn assemblies are delay signed.</li>
 <li>In this case I didn't even need to compile or get a semantic model, the syntax tree was enough for me. If you need to go further (such as using symbol information) you can always bring in the Roslyn compilation APIs.</li>
 <li>I prefer to write my T4 templates entirely in C# and output content using <code>WriteLine()</code>. You can obviously use a different approach such as interspersing control logic with template content.</li>
</ul></div>
</div>
<hr />

<div class="row">
 <div class="col-sm-12">        <div id="disqus_thread"></div>
        <script type="text/javascript">
            /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
            var disqus_shortname = 'somedave'; // required: replace example with your forum shortname
            var disqus_identifier = 'compiler-platform-in-t4';
            var disqus_title = 'Using the .NET Compiler Platform in T4 Templates';
            var disqus_url = 'http://www.daveaglick.com/posts/compiler-platform-in-t4';

            /* * * DON'T EDIT BELOW THIS LINE * * */
            (function() {
                var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
                dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
                (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
            })();
        </script>
        <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
        <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>    
</div>
</div></div>
  </div>
 </div>
</div>        
<div id="sticky-footer-wrapper">
 <div id="sticky-footer">
  <div class="container">
   <small>                        
                            Copyright © 2015 by Dave Glick. All jams and jellies preserved. The opinions expressed herein are my own and do not represent those of my employer or any other third-party views in any way. This work is licensed under a
                            <a href="http://creativecommons.org/licenses/by/4.0/" rel="license">
    <span class="icon-creative-commons"></span> Creative Commons Attribution 4.0 International License</a>.
                            <br />
                            <a href="/feed.rss">
    <span class="icon-rss"></span> RSS Feed</a> | <a href="/feed.atom">
    <span class="icon-rss"></span> Atom Feed</a>
                            <br />
                            <a href="https://github.com/daveaglick/daveaglick">
    <span class="icon-github-square"></span> This Site on GitHub</a> | <strong><a href="http://wyam.io">Generated by Wyam</a></strong>
                        

   </small>
  </div>
 </div>
</div>
        <script type="text/javascript">
            /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
            var disqus_shortname = 'somedave'; // required: replace example with your forum shortname

            /* * * DON'T EDIT BELOW THIS LINE * * */
            (function () {
                var s = document.createElement('script'); s.async = true;
                s.type = 'text/javascript';
                s.src = '//' + disqus_shortname + '.disqus.com/count.js';
                (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
            }());

            // Google Analytics
            (function (i, s, o, g, r, a, m) {
                i['GoogleAnalyticsObject'] = r; i[r] = i[r] || function () {
                    (i[r].q = i[r].q || []).push(arguments)
                }, i[r].l = 1 * new Date(); a = s.createElement(o),
                m = s.getElementsByTagName(o)[0]; a.async = 1; a.src = g; m.parentNode.insertBefore(a, m)
            })(window, document, 'script', '//www.google-analytics.com/analytics.js', 'ga');

            ga('create', 'UA-54470483-1', 'auto');
            ga('send', 'pageview');

            // Twitter
            window.twttr = (function (d, s, id) {
                var t, js, fjs = d.getElementsByTagName(s)[0];
                if (d.getElementById(id)) return;
                js = d.createElement(s); js.id = id;
                js.src = "https://platform.twitter.com/widgets.js";
                fjs.parentNode.insertBefore(js, fjs);
                return window.twttr || (t = { _e: [], ready: function (f) { t._e.push(f) } });
            }(document, "script", "twitter-wjs"));

            // Background
            var colors = Please.make_color({
                golden: false,
                colors_returned: 3,
                saturation: .4
            });
            var t = new Trianglify({
                x_gradient: colors,
                y_gradient: ["#FFFFFF"]
            });
            var pattern = t.generate(document.body.clientWidth, document.body.clientHeight);
            document.body.setAttribute('style', 'background-image: ' + pattern.dataUrl);
        </script>
	</bodyonload="prettyPrint()">
</html>

