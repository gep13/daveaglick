


<!DOCTYPE html>
<html lang="en">
	<head>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=Edge"/>

	<title>Dave Glick - Serving Extensionless URLs with OWIN</title>
        <meta name="description" content="The personal blog of Dave Glick" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0">        

        <link type="application/rss+xml" rel="alternate" title="Dave Glick" href="/feed.rss" />
        <link type="application/atom+xml" rel="alternate" title="Dave Glick" href="/feed.atom" />
        <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
        <link rel="icon" href="/favicon.ico" type="image/x-icon">
        <link rel="icon" type="image/png" href="/favicon-32x32.png" sizes="32x32" />
        <link rel="icon" type="image/png" href="/favicon-16x16.png" sizes="16x16" />

        <link href="/Content/bootstrap/bootstrap.css" rel="stylesheet" />
        <link href="/Content/prettify.css" rel="stylesheet">
        <link href="/Content/github.css" rel="stylesheet">
        <link href="/Content/clean-blog.css" rel="stylesheet" />
        <link href="/Content/master.css" rel="stylesheet" />
        <link href="http://maxcdn.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.min.css" rel="stylesheet" type="text/css">
        <link href='http://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
        <link href='http://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/css'>


        <meta name="application-name" content="Dave Glick" />
        <meta name="msapplication-tooltip" content="Dave Glick" />
        <meta name="msapplication-starturl" content="/" />

        <meta property="og:title" content="Dave Glick - Serving Extensionless URLs with OWIN" />
        
        <meta property="og:type" content="website" />
        <meta property="og:url" content="http://daveaglick.com/posts/serving-extensionless-urls-with-owin" />
        <!-- TODO: More social graph meta tags -->

        <script src="/Scripts/jquery-2.1.1.min.js"></script>
        <script src="/Scripts/bootstrap.min.js"></script>     
        <script src="/Scripts/prettify.js"></script>
        <script src="/Scripts/clean-blog.js"></script>
        <script src="http://d3js.org/d3.v3.min.js"></script>
        <script src="/Scripts/trianglify.min.js"></script>
        <script src="/Scripts/Please-compressed.js"></script>
        </script>
            
        <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
        <!--[if lt IE 9]>
                <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
                <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
        <![endif]-->
    
	</head>
	<body onload="prettyPrint()">
                
                <!-- Navigation -->
                <nav class="navbar navbar-default navbar-custom navbar-fixed-top">
                        <div class="container-fluid">
                                <!-- Brand and toggle get grouped for better mobile display -->
                                <div class="navbar-header page-scroll">
                                        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#navbar-collapse">
                                        <span class="sr-only">Toggle navigation</span>
                                        <span class="icon-bar"></span>
                                        <span class="icon-bar"></span>
                                        <span class="icon-bar"></span>
                                        </button>
                                        <a class="navbar-brand" href="/">Dave Glick</a>
                                </div>
                        
                                <!-- Collect the nav links, forms, and other content for toggling -->
                                <div class="collapse navbar-collapse" id="navbar-collapse">
                                        <ul class="nav navbar-nav navbar-right">
                                                <li><a href="http://wyam.io/">Wyam</a></li>
                                                <li><a href="http://fluentbootstrap.com/">FluentBootstrap</a></li>
                                                <li><a class="hidden-xs">|</a><a class="visible-xs-block">-</a></li>
                                                <li><a href="/about">About</a></li>
                                                <li><a href="/posts">Archive</a></li>
                                                <li><a href="/tags">Tags</a></li>
                                        </ul>
                                </div>
                                <!-- /.navbar-collapse -->
                        </div>
                        <!-- /.container -->
                </nav>
                
                <!-- Page Header -->
                <header class="intro-header" id="intro-header">
                        <div class="container">
                                <div class="row">
                                        <div class="col-md-12">

    <div class="post-heading">
        <h1>Serving Extensionless URLs with OWIN</h1>
            <h2 class="subheading">My first OWIN middleware.</h2>
        <div class="meta">        
                Published on Wednesday, July 8, 2015<br>
                    </div>
            <div class="tags">

<a role="button" href="/tags/owin" class="btn btn-default btn-sm"> OWIN</a>            </div>     
    </div>
                                        </div>
                                </div>
                        </div>
                </header>
                
                <!-- Main Content -->
                <div class="container">
                        <div class="row">
                                <div class="col-md-12">
                                        



<p><a href="http://wyam.io">I recently</a> had a need for an embedded web server. In the past, I've used a variety of libraries for this purpose (including building my own kind-of standards-compliant HTTP server - don't do this), but have always had my eye on the <a href="http://owin.org/">OWIN specification</a> and related projects. Specifically, the <a href="http://katanaproject.codeplex.com/documentation">Katana project</a> from Microsoft looked interesting. Each previous time I investigated it, it looked like it was still pretty rough and needed a little more time. I was pleased to find what looked like a mature and easy to integrate library this time around though.</p>
<p>There is lots of great documentation and many blog posts about what OWIN is and how it works so I won't go into detail here. In a nutshell, OWIN provides a standard interface to hook into the web serving pipeline and do whatever you need to do to the request and/or response. The idea is that you can easily change the behavior of your web host (be it embedded, on a server, etc.) by swapping out different &quot;middleware&quot;.</p>
<p>For Wyam, I wanted the embedded server to handle extensionless URLs. An extensionless URL is one in which the web server infers the file extension based on what files are available without having to specify it directly in the URL. For example, if there is a file named <code>mypage.html</code> you could access it at <code>http://mydomain.com/mypage</code> instead of <code>http://mydomain.com/mypage.html</code>. These extensionless URLs are easier to remember, are favored by search engines, and allow for easier migration to other technologies. Several web hosts support this concept (including GitHub Pages) and if someone is deploying to those hosts (or configured their own server to be extensionless), I wanted the Wyam preview server to support it.</p>
<p>Unfortunatly, Katana (and OWIN) doesn't support this idea out of the box. I also searched for custom middleware to do this and came up empty. Time to learn how to write OWIN middleware...</p>
<p>It was remarkably easy. I copied the conventions for some of the default middleware in Katana and just changed the behavior a little bit. I'll start with the options class:</p>
<pre class="prettyprint"><code>public class ExtensionlessUrlsOptions
{
    public ExtensionlessUrlsOptions()
    {
        // Prioritized list
        DefaultExtensions = new List&lt;string&gt;()
        {
            &quot;.htm&quot;,
            &quot;.html&quot;
        };
    }

    public IList&lt;string&gt; DefaultExtensions { get; set; }
    public IFileSystem FileSystem { get; set; }
}
</code></pre>
<p>This just holds the list of default extensions to check and the OWIN <code>IFileSystem</code> object that will be used to check for files.</p>
<p>The actual middleware class is below:</p>
<pre class="prettyprint"><code>using AppFunc = Func&lt;IDictionary&lt;string, object&gt;, Task&gt;;

public class ExtensionlessUrlsMiddleware
{
    private readonly ExtensionlessUrlsOptions _options;
    private readonly AppFunc _next;

    public ExtensionlessUrlsMiddleware(AppFunc next, ExtensionlessUrlsOptions options)
    {
        if (next == null)
        {
            throw new ArgumentNullException(&quot;next&quot;);
        }
        if (options == null)
        {
            throw new ArgumentNullException(&quot;options&quot;);
        }
        if (options.FileSystem == null)
        {
            options.FileSystem = new PhysicalFileSystem(&quot;.&quot;);
        }
        options.DefaultExtensions =
            options.DefaultExtensions.Select(x =&gt; x.StartsWith(&quot;.&quot;) ? x : (&quot;.&quot; + x)).ToList();

        _next = next;
        _options = options;
    }

    public Task Invoke(IDictionary&lt;string, object&gt; environment)
    {
        IOwinContext context = new OwinContext(environment);
        if (IsGetOrHeadMethod(context.Request.Method)
            &amp;&amp; !PathEndsInSlash(context.Request.Path))
        {
            // Check if there's a file with the matched extension, and rewrite the request if found
            foreach (string extension in _options.DefaultExtensions)
            {
                string filePath = context.Request.Path + extension;
                IFileInfo fileInfo;
                if (_options.FileSystem.TryGetFileInfo(filePath, out fileInfo))
                {
                    context.Request.Path = new PathString(filePath);
                    break;
                }
            }
        }

        return _next(environment);
    }

    // These methods are from Microsoft.Owin.StaticFiles.Helpers
    private static bool IsGetOrHeadMethod(string method)
    {
        return IsGetMethod(method) || IsHeadMethod(method);
    }

    private static bool IsGetMethod(string method)
    {
        return string.Equals(&quot;GET&quot;, method, StringComparison.OrdinalIgnoreCase);
    }

    private static bool IsHeadMethod(string method)
    {
        return string.Equals(&quot;HEAD&quot;, method, StringComparison.OrdinalIgnoreCase);
    }

    private static bool PathEndsInSlash(PathString path)
    {
        return path.Value.EndsWith(&quot;/&quot;, StringComparison.Ordinal);
    }
}
</code></pre>
<p>You can see that besides some housekeeping code, it's very straightforward. Literally all we're doing is checking if a file exists with one of our default extensions and then rewritting the query to include the extension if a file does exist. That way, downstream middleware will just see the request with the extension and it'll work as if the extension were there all along.</p>
<p>To actually use the middleware, I wrote some short extensions:</p>
<pre class="prettyprint"><code>public static class ExtensionlessUrlsExtensions
{
    public static IAppBuilder UseExtensionlessUrls(this IAppBuilder builder)
    {
        return builder.UseExtensionlessUrls(new ExtensionlessUrlsOptions());
    }

    public static IAppBuilder UseExtensionlessUrls(this IAppBuilder builder, ExtensionlessUrlsOptions options)
    {
        if (builder == null)
        {
            throw new ArgumentNullException(&quot;builder&quot;);
        }

        return builder.Use&lt;ExtensionlessUrlsMiddleware&gt;(options);
    }
}
</code></pre>
<p>And then placed this code where I spin up the server:</p>
<pre class="prettyprint"><code>WebApp.Start(options, app =&gt;
{
    IFileSystem outputFolder = new PhysicalFileSystem(/* output folder */);

    // ...
    
    app.UseExtensionlessUrls(new ExtensionlessUrlsOptions
    {
        FileSystem = outputFolder
    });
    
    // ...
});
</code></pre>



<div id="disqus_thread"></div>
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'somedave'; // required: replace example with your forum shortname
    var disqus_identifier = 'serving-extensionless-urls-with-owin';
    var disqus_title = 'Serving Extensionless URLs with OWIN';
    var disqus_url = 'http://www.daveaglick.com/posts/serving-extensionless-urls-with-owin';

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>    

                                </div>
                        </div>
                </div>
                
                <hr>
                
                <!-- Footer -->
                <footer>
                        <div class="container">
                                <div class="row">
                                        <div class="col-md-12">
                                        <ul class="list-inline text-center">
                                                <li>
                                                <a href="https://twitter.com/daveaglick">
                                                        <span class="fa-stack fa-lg">
                                                        <i class="fa fa-circle fa-stack-2x"></i>
                                                        <i class="fa fa-twitter fa-stack-1x fa-inverse"></i>
                                                        </span>
                                                </a>
                                                </li>
                                                <li>
                                                <a href="https://github.com/daveaglick">
                                                        <span class="fa-stack fa-lg">
                                                        <i class="fa fa-circle fa-stack-2x"></i>
                                                        <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                                                        </span>
                                                </a>
                                                </li>
                                        </ul>
                                        <p class="copyright text-muted">
                                                Copyright © 2015 by Dave Glick. All jams and jellies preserved. The opinions expressed herein are my own and do not represent those of my employer or any other third-party views in any way. This work is licensed under a <a href="http://creativecommons.org/licenses/by/4.0/" rel="license">Creative Commons Attribution 4.0 International License</a>.
                                                <br />
                                                <a href="/feed.rss"><i class="fa fa-rss"></i> RSS Feed</a> | <a href="/feed.atom"><i class="fa fa-rss"></i> Atom Feed</a>
                                                <br />
                                                <a href="https://github.com/daveaglick/daveaglick"><i class="fa fa-github"></i> This Site on GitHub</a> | <strong><a href="http://wyam.io">Generated by Wyam</a></strong>
                                        </p>
                                        </div>
                                </div>
                        </div>
                </footer> 
        
                <script type="text/javascript">
                        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
                        var disqus_shortname = 'somedave'; // required: replace example with your forum shortname
                
                        /* * * DON'T EDIT BELOW THIS LINE * * */
                        (function () {
                                var s = document.createElement('script'); s.async = true;
                                s.type = 'text/javascript';
                                s.src = '//' + disqus_shortname + '.disqus.com/count.js';
                                (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
                        }());
                
                        // Google Analytics
                        (function (i, s, o, g, r, a, m) {
                                i['GoogleAnalyticsObject'] = r; i[r] = i[r] || function () {
                                (i[r].q = i[r].q || []).push(arguments)
                                }, i[r].l = 1 * new Date(); a = s.createElement(o),
                                m = s.getElementsByTagName(o)[0]; a.async = 1; a.src = g; m.parentNode.insertBefore(a, m)
                        })(window, document, 'script', '//www.google-analytics.com/analytics.js', 'ga');
                
                        ga('create', 'UA-54470483-1', 'auto');
                        ga('send', 'pageview');
                
                        // Background                        
                        var colors = Please.make_color({
                                colors_returned: 3,
                                saturation: .6
                        });
                        var t = new Trianglify({
                                x_gradient: colors,
                                y_gradient: ["#FFFFFF"]
                        });
                        var header = document.getElementById("intro-header");
                        var pattern = t.generate(header.clientWidth, header.clientHeight);
                        header.setAttribute('style', 'background-image: ' + pattern.dataUrl);                        
                </script>
        </body>
</html>

